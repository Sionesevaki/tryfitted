services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-tryfitted}
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    # If you expose Redis publicly, you MUST set a strong password and firewall the port.
    # Prefer VPN (Tailscale/WireGuard) instead of public exposure.
    command:
      [
        "redis-server",
        "--appendonly",
        "yes",
        "--requirepass",
        "${REDIS_PASSWORD:?Set REDIS_PASSWORD in Coolify stack env}",
        "--bind",
        "0.0.0.0",
        "--protected-mode",
        "no"
      ]
    volumes:
      - redis_data:/data
    # For RunPod worker access you may need to publish this port.
    # Prefer firewall/VPN instead of exposing Redis to the internet.
    # ports:
    #   - "6379:6379"

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-minioadmin}
    volumes:
      - minio_data:/data
    # Expose ports to Coolify's proxy (do not publish raw ports unless you want public access).
    expose:
      - "9000" # S3 API
      - "9001" # Console
    # Publish via Coolify domains (recommended) or uncomment for raw ports:
    # ports:
    #   - "9000:9000"
    #   - "9001:9001"

  minio-init:
    image: minio/mc:latest
    depends_on:
      - minio
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "
      until (/usr/bin/mc alias set local http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD}) do sleep 1; done;
      /usr/bin/mc mb -p local/$${S3_BUCKET} || true;
      exit 0;
      "
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-tryfitted}

  api:
    image: ghcr.io/${GITHUB_REPO_OWNER:-your-org}/tryfitted-api:${API_IMAGE_TAG:-main}
    depends_on:
      - postgres
      - redis
      - minio
      - minio-init
    environment:
      API_PORT: 3001
      API_HOST: 0.0.0.0
      LOG_LEVEL: info
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/tryfitted?schema=public}
      # Use internal redis hostname by default; ensure password matches REDIS_PASSWORD above.
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_PUBLIC_BASE_URL: ${S3_PUBLIC_BASE_URL:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-tryfitted}
    expose:
      - "3001"
    # Publish via Coolify domain (recommended) or uncomment:
    # ports:
    #   - "3001:3001"

volumes:
  postgres_data:
  redis_data:
  minio_data:
